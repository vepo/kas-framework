version: '3'
services:
  producer:
    image: openjdk:21-jdk
    command: java -jar /app/data-generator-jar-with-dependencies.jar -d /app/train-data -t 10 -r 10000 train
    deploy:
      mode: replicated
      replicas: 6
    environment:
      LARGE_DATA: false
    volumes:
      - ./runtime:/app
    networks:
      - maestro-network
  stream-default:
    image: openjdk:21-jdk
    command: java -Xms1g -Xmx1g -jar /app/sample-stream-jar-with-dependencies.jar
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 1.5gb
        reservations:
          cpus: '0.5'
          memory: 1.5gb
    environment:
      APP_ID: stream-default
      # PARAMETER_NAME: consumer.max.partition.fetch.bytes
      # PARAMETER_VALUE: 1048576
      # PARAMETER_NAME: consumer.fetch.max.bytes
      # PARAMETER_VALUE: 52428800
      # PARAMETER_NAME: consumer.max.poll.records
      # PARAMETER_VALUE: 500
      # PARAMETER_NAME: consumer.fetch.min.bytes
      # PARAMETER_VALUE: 512
      # PARAMETER_NAME: consumer.fetch.max.wait.ms
      # PARAMETER_VALUE: 500
      # PARAMETER_NAME: consumer.receive.buffer.bytes
      # PARAMETER_VALUE: 65536
      # PARAMETER_NAME: producer.send.buffer.bytes
      # PARAMETER_VALUE: 131072
      PARAMETER_NAME: producer.linger.ms
      PARAMETER_VALUE: 10
      STATS_FOLDER: /app/stats
      THREADS: 4
      TEST_ID: default
      PIPELINE: TRANSFORM
      # PIPELINE: AGGREGATION
    volumes:
      - ./runtime:/app
      - ./stats/default:/app/stats
    networks:
      - maestro-network
  stream-low: ## -25%
    image: openjdk:21-jdk
    command: java -Xms1g -Xmx1g -jar /app/sample-stream-jar-with-dependencies.jar
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 1.5gb
        reservations:
          cpus: '0.5'
          memory: 1.5gb
    environment:
      APP_ID: stream-low
      # PARAMETER_NAME: consumer.max.partition.fetch.bytes
      # PARAMETER_VALUE: 786432
      # PARAMETER_NAME: consumer.fetch.max.bytes
      # PARAMETER_VALUE: 39321600
      # PARAMETER_NAME: consumer.max.poll.records
      # PARAMETER_VALUE: 375
      # PARAMETER_NAME: consumer.fetch.min.bytes
      # PARAMETER_VALUE: 1
      # PARAMETER_NAME: consumer.fetch.max.wait.ms
      # PARAMETER_VALUE: 375
      # PARAMETER_NAME: consumer.receive.buffer.bytes
      # PARAMETER_VALUE: 49152
      # PARAMETER_NAME: producer.send.buffer.bytes
      # PARAMETER_VALUE: 98304
      PARAMETER_NAME: producer.linger.ms
      PARAMETER_VALUE: 0
      STATS_FOLDER: /app/stats
      THREADS: 4
      TEST_ID: low
      PIPELINE: TRANSFORM
      # PIPELINE: AGGREGATION
    volumes:
      - ./runtime:/app
      - ./stats/low:/app/stats
    networks:
      - maestro-network
  stream-high: ## +25%
    image: openjdk:21-jdk
    command: java -Xms1g -Xmx1g -jar /app/sample-stream-jar-with-dependencies.jar
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 1.5gb
        reservations:
          cpus: '0.5'
          memory: 1.5gb
    environment:
      APP_ID: stream-high
      # PARAMETER_NAME: consumer.max.partition.fetch.bytes
      # PARAMETER_VALUE: 1310720
      # PARAMETER_NAME: consumer.fetch.max.bytes
      # PARAMETER_VALUE: 65536000
      # PARAMETER_NAME: consumer.max.poll.records
      # PARAMETER_VALUE: 625
      # PARAMETER_NAME: consumer.fetch.min.bytes
      # PARAMETER_VALUE: 8192
      # PARAMETER_NAME: consumer.fetch.max.wait.ms
      # PARAMETER_VALUE: 625
      # PARAMETER_NAME: consumer.receive.buffer.bytes
      # PARAMETER_VALUE: 81920
      # PARAMETER_NAME: producer.send.buffer.bytes
      # PARAMETER_VALUE: 163840
      PARAMETER_NAME: producer.linger.ms
      PARAMETER_VALUE: 50
      STATS_FOLDER: /app/stats
      THREADS: 4
      TEST_ID: high
      PIPELINE: TRANSFORM
      # PIPELINE: AGGREGATION
    volumes:
      - ./runtime:/app
      - ./stats/high:/app/stats
    networks:
      - maestro-network
networks:
  maestro-network:
    external: true